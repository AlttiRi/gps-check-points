{"version":3,"file":"index.js","sources":["../src/util.ts","../src/components/Main.vue","../src/main.ts"],"sourcesContent":["export function renderTemplateString(template: string, props: Record<string, any>) {\n    let hasUndefined = false;\n    const value = template.replaceAll(/{[^{}]+?}/g, (match, _index, _string) => {\n        const key = match.slice(1, -1);\n        const value = props[key];\n        if (value === undefined) {\n            console.warn(`[renderTemplateString] ${match} is undefined`);\n            hasUndefined = true;\n        }\n        return value;\n    });\n    return {hasUndefined, value};\n}\n","<script setup lang=\"ts\">\nimport {computed, Ref, ref, watch} from \"vue\";\nimport {set, entries, createStore} from \"idb-keyval\";\nimport {formatDate} from \"@alttiri/util-js\";\n\nconst gpsPointsStore = createStore(\"GPS_Points_DB\", \"GPS_Points\");\n\nconst coordObj: Ref<GeolocationPosition | undefined> = ref();\nconst savedPoints: Ref<GeolocationPosition[]> = ref([]);\n\nasync function loadSavedPoints() {\n    const gpsEntries: Array<[number, GeolocationCoordinates]> = await entries(gpsPointsStore);\n    savedPoints.value = [];\n    for (const gpsEntry of gpsEntries) {\n        savedPoints.value.push({\n            timestamp: gpsEntry[0],\n            coords: gpsEntry[1],\n        });\n    }\n    savedPoints.value = savedPoints.value.reverse()\n}\nvoid loadSavedPoints();\n\nasync function getCoords(): Promise<GeolocationPosition> {\n    return new Promise((resolve, reject) => {\n        navigator.geolocation.getCurrentPosition(\n            (location: GeolocationPosition) => resolve(location),\n            (error: GeolocationPositionError) => reject(error),\n            {\n                enableHighAccuracy: true,\n            },\n        );\n    });\n}\n\nfunction objectify<T>(target: T): T {\n    const obj: any = {};\n    for (const key in target) {\n        if (isObject(target[key])) {\n            obj[key] = objectify(target[key]);\n            continue;\n        }\n        obj[key] = target[key as keyof T];\n    }\n    return obj as T;\n}\n\nasync function onUpdateClick() {\n    try {\n        coordObj.value = await getCoords();\n        saved.value = false;\n    } catch (e) {\n        alert(JSON.stringify(objectify(e as GeolocationPositionError), null, \"  \"));\n    }\n}\nvoid onUpdateClick();\n\nconst saved = ref(false);\nasync function onSaveClick() {\n    if (!coordObj.value) {\n        return;\n    }\n    try {\n        await set(coordObj.value.timestamp, objectify(coordObj.value.coords), gpsPointsStore);\n        savedPoints.value.unshift(objectify(coordObj.value));\n        saved.value = true;\n    } catch (e) {\n        alert(JSON.stringify(objectify(e), null, \"  \"));\n    }\n}\n\nfunction isObject(target: any): target is object {\n    return typeof target === \"object\" && !Array.isArray(target) && target !== null;\n}\n\nasync function exportPoints() {\n    const copySavedPoints = [...savedPoints.value];\n    copySavedPoints.sort((p1, p2) => p1.timestamp - p2.timestamp);\n    const text = JSON.stringify(copySavedPoints);\n    console.log(text);\n    return text;\n}\n\nimport * as fflate from \"fflate\";\nimport {encodeBase85, decodeBase85} from \"@alttiri/base85\";\nimport {renderTemplateString} from \"../util\";\n\nasync function onSharePoints() {\n    const pointsText = await exportPoints();\n    const pointsTextEnc = encodeBase85(fflate.deflateSync(new TextEncoder().encode(pointsText)));\n\n    if (!navigator.canShare) {\n        alert(\"Sharing is not supported\");\n        console.log(\"pointsTextEnc\");\n        console.log(pointsTextEnc);\n        return;\n    }\n\n    const share: ShareData = {\n        title: pointsTextEnc,\n    };\n    try {\n        await navigator.share(share);\n    } catch (e) {\n        alert(JSON.stringify(objectify(e), null, \"  \"));\n    }\n}\nasync function importPoints(data: string) {\n    const json = new TextDecoder().decode(fflate.inflateSync(decodeBase85(data)));\n    const entries: GeolocationPosition[] = JSON.parse(json);\n    console.log(entries);\n    for (const entry of entries) {\n        await set(entry.timestamp, objectify(entry.coords), gpsPointsStore);\n    }\n    await loadSavedPoints();\n}\n\n//@ts-ignore\nglobalThis.importPoints = importPoints;\n\n// for example, \"https://www.google.ru/maps/@{latitude},{longitude},17z\"\nconst template = ref(localStorage.getItem(\"gps-pattern-url\") || \"\");\nwatch(template, value => {\n    localStorage.setItem(\"gps-pattern-url\", value);\n});\n\nconst badTemplate = ref(false);\nconst link = computed(() => {\n    if (!coordObj.value) {\n        badTemplate.value = false;\n        return \"\";\n    }\n    const result = renderTemplateString(template.value, coordObj.value.coords);\n    badTemplate.value = result.hasUndefined;\n    return result.value;\n});\n\n</script>\n\n<template>\n    <div class=\"main\">\n        <button @click=\"onUpdateClick\">Update Point</button>\n        <button @click=\"onSaveClick\" :disabled=\"saved\">Save Point</button>\n        <button @click=\"onSharePoints\" >Share</button>\n        <table class=\"coord\" v-if=\"coordObj\">\n            <tr v-for=\"[k, v] of Object.entries(objectify(coordObj.coords)).filter(([_k, _v]) => _v)\">\n                <td>{{ k }}</td>: <td>{{ v }}</td>\n            </tr>\n            <tr class=\"date\">\n                <td>timestamp</td>: <td>{{ formatDate(coordObj.timestamp, \"YYYY.MM.DD HH:mm:SS\", false) }}</td>\n            </tr>\n        </table>\n    </div>\n    <div class=\"saved\">\n        <hr>\n        <input type=\"text\" v-model=\"template\" name=\"coord-pattern-url\" spellcheck=\"false\" :class=\"{red: badTemplate}\">\n        <div v-if=\"template && coordObj\">\n            <a :href=\"link\" target=\"_blank\" rel=\"noopener noreferrer\">{{ link }}</a>\n        </div>\n        <div class=\"saved-coord\" v-if=\"savedPoints.length\">\n            <hr>\n            <div v-for=\"point of savedPoints\" class=\"entry\">\n                <div class=\"date\">{{ formatDate(point.timestamp, \"YYYY.MM.DD HH:mm:SS\", false) }}</div>\n                <div v-for=\"[k, v] of Object.entries(point.coords).filter(([_k, _v]) => _v)\">\n                    <span>{{ k }}</span>: <span>{{ v }}</span>\n                </div>\n                <div class=\"out-link\" v-if=\"template\">\n                    <a :href=\"renderTemplateString(template, point.coords).value\" target=\"_blank\" rel=\"noopener noreferrer\">link</a>\n                </div>\n                <hr>\n            </div>\n        </div>\n    </div>\n</template>\n\n<style scoped lang=\"scss\">\n.red {\n    border-color: red;\n}\n.entry {\n    position: relative;\n    .out-link {\n        position: absolute;\n        right: 5px;\n        bottom: 5px;\n    }\n}\n.entry:not(:hover) {\n    .out-link {\n        display: none;\n    }\n}\ninput {\n    font-size: 16px;\n    padding: 10px;\n    border: 2px solid #ccc;\n    border-radius: 5px;\n    outline: none;\n    box-shadow: none;\n    margin-bottom: 5px;\n\n    width: 100%;\n    box-sizing: border-box;\n}\n\nbutton {\n    background-color: #4CAF50;\n    border: none;\n    color: white;\n    padding: 10px 20px;\n    text-align: center;\n    text-decoration: none;\n    display: inline-block;\n    font-size: 16px;\n    cursor: pointer;\n    border-radius: 4px;\n    outline: 0;\n    margin: 5px;\n}\nbutton:active {\n    box-shadow: 0 0 3px grey;\n}\nbutton[disabled] {\n    background-color: gray;\n}\n.date {\n    color: grey;\n}\n</style>\n","import {createApp} from \"vue\";\nimport App from \"./App.vue\";\n\ncreateApp(App).mount(\"#app\");\n"],"names":["renderTemplateString","template","props","hasUndefined","value","match","_index","_string","key","gpsPointsStore","createStore","coordObj","ref","savedPoints","loadSavedPoints","gpsEntries","entries","gpsEntry","getCoords","resolve","reject","location","error","objectify","target","obj","isObject","onUpdateClick","saved","onSaveClick","set","exportPoints","copySavedPoints","p1","p2","text","onSharePoints","pointsText","pointsTextEnc","encodeBase85","fflate.deflateSync","share","e","importPoints","data","json","fflate.inflateSync","decodeBase85","entry","watch","badTemplate","link","computed","result","createApp","App"],"mappings":"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"}